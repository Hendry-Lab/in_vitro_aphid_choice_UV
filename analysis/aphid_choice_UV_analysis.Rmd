---
title: "In Vitro Aphid Choice UV"
output:
  pdf_document:
    latex_engine: xelatex
    toc: true
  html_document:
    css: css/tufte.css
    toc: true
    toc_float: true
  word_document:
    toc: true
    reference_docx: templates/wordstyletemplate.docx
    keep_md: true
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, tidy.opts = list, tidy = TRUE, fig.align = "center", # Always relative to the document directory
                      fig.path = "../figures/", # Send any figures to this folder
                      dev = "pdf",  # Export figures as PDF
                      width = 1,
                      height = 2,
                      dpi = 350)  # Set the resolution to 300 dots per inch (dpi)
```

# Load Libraries

```{r load-packages}
pacman::p_load(ggplot2, readxl, ggbeeswarm, readr, dplyr, tidyr, tidyverse, devtools, cowplot, knitr, emmeans, lme4, lmerTest, RColorBrewer, viridis, install = FALSE)
```

# Load Data

```{r load-data}
aphid_choice_raw <- read_excel("data/alate_choice_in_vitro.xlsx") %>%
   mutate(block = as.factor(block))
```

## Summarize aphid counts

```{r aphid sums}
aphid_choice_sum <- aphid_choice_raw %>%
  group_by(block, treatment, box, UV) %>%
  summarize(
    total_alates_4_hrs = sum(alates_4_hrs),
    total_nymphs_4_hrs = sum(nymphs_4_hrs),
    total_alates_24_hrs = sum(alates_24_hrs),
    total_nymphs_24_hrs = sum(nymphs_24_hrs),
    .groups = "drop"
  )

# reshape
aphid_choice_sum <- aphid_choice_sum %>%
  filter(treatment %in% c("220_supernatant", "PPM")) %>%   # Keep only relevant treatments
  pivot_wider(
    names_from = treatment, 
    values_from = c(total_alates_4_hrs, total_nymphs_4_hrs, total_alates_24_hrs, total_nymphs_24_hrs),
    names_glue = "{.value}_{treatment}"
  ) %>%
  select(block, box, UV, 
         alates_220_supernatant_4_hrs = total_alates_4_hrs_220_supernatant,
         alates_PPM_4_hrs = total_alates_4_hrs_PPM,
         nymphs_220_supernatant_4_hrs = total_nymphs_4_hrs_220_supernatant,
         nymphs_PPM_4_hrs = total_nymphs_4_hrs_PPM,
         alates_220_supernatant_24_hrs = total_alates_24_hrs_220_supernatant,
         alates_PPM_24_hrs = total_alates_24_hrs_PPM,
         nymphs_220_supernatant_24_hrs = total_nymphs_24_hrs_220_supernatant,
         nymphs_PPM_24_hrs = total_nymphs_24_hrs_PPM)
```

## Calculate percent aphid counts and deviations from 50%
```{r calc-percents}
# separate by box
# calculate percents
aphid_choice_percent_box <- aphid_choice_sum %>%
  group_by(block, box, UV) %>%
  summarize(
    percent_choice_4hrs = (100 * (alates_220_supernatant_4_hrs / (alates_220_supernatant_4_hrs + alates_PPM_4_hrs))))

# Summarize the data by block and UV, calculating average deviation from 50%
aphid_choice_deviation_box <- aphid_choice_percent_box %>%
  group_by(block, box, UV) %>%
  summarize(
    average_deviation_50percent_choice_4hrs = abs(50 - percent_choice_4hrs))
```

# Plots

## 4 Hour Alate Choice

```{r 4hour_alate_choice}
# remove block 1
aphid_choice_sum_no_block1 <- aphid_choice_sum %>%
  filter(block != "1")

# plot 4 hour alate choice
ggplot(aphid_choice_sum_no_block1, aes(x = box, y = 100*(alates_220_supernatant_4_hrs/(alates_220_supernatant_4_hrs+alates_PPM_4_hrs)), fill = UV)) +
  geom_col(width = 0.5) +
  facet_grid(~block) +
  labs(x = "Box", y = "Percent Alates Choosing #220 Supernatant", title = "4 Hours Alate Choice") +
  theme(panel.background = element_rect(fill = "white"), panel.grid.major = element_line(color = "gray90"), panel.grid.major.x = element_blank(),
  panel.grid.minor.x = element_blank(), axis.text.x = element_blank()) # Removes x-axis labels

# plot 4 hour alate choice - deviation from 50%
ggplot(aphid_choice_sum_no_block1, aes(x = box, y = abs(50- (100*(alates_220_supernatant_4_hrs/(alates_220_supernatant_4_hrs+alates_PPM_4_hrs)))), fill = UV)) +
  geom_col(width = 0.5) +
  facet_grid(~block) +
  labs(x = "Box", y = "Deviation from 50%", title = "4 Hours Alate #220 Treatment Choice", subtitle = "Absolute Deviation from 50%") +
  theme(panel.background = element_rect(fill = "white"), panel.grid.major = element_line(color = "gray90"), panel.grid.major.x = element_blank(),
  panel.grid.minor.x = element_blank(), axis.text.x = element_blank()) # Removes x-axis labels

# plot block level 4 hour alate choice - deviation from 50%
ggplot(aphid_choice_sum_no_block1, aes(x = block, y = abs(50- (100*(alates_220_supernatant_4_hrs/(alates_220_supernatant_4_hrs+alates_PPM_4_hrs)))), fill = UV)) +
  geom_col(position = "dodge", width = 0.5) +
  labs(x = "Box", y = "Deviation from 50%", title = "4 Hours Alate #220 Treatment Choice", subtitle = "Absolute Deviation from 50%") +
  theme(panel.background = element_rect(fill = "white"), panel.grid.major = element_line(color = "gray90"), panel.grid.major.x = element_blank(),
  panel.grid.minor.x = element_blank(), axis.text.x = element_blank()) # Removes x-axis labels
```
